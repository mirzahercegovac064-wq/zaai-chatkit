<!doctype html>
<html lang="sv">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatKit test (Render)</title>

    <script
      src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js"
      async
    ></script>
  </head>

  <body style="font-family: system-ui; padding: 16px;">
    <h1>ChatKit test (utan Framer)</h1>

    <button id="start" style="padding:10px 12px;border-radius:10px;border:1px solid #ccc;cursor:pointer;">
      Start chat
    </button>

    <div id="mount" style="margin-top:16px;"></div>

    <script>
      const BACKEND = "https://YOUR-BACKEND.onrender.com"; // <-- Ã¤ndra

      async function getClientSecret() {
        const res = await fetch(`${BACKEND}/api/chatkit/session`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ device_id: localStorage.getItem("device_id") || null }),
        });

        if (!res.ok) throw new Error(`Session failed ${res.status}: ${await res.text()}`);
        const data = await res.json();
        if (data.user) localStorage.setItem("device_id", data.user);
        if (!data.client_secret) throw new Error("Missing client_secret");
        return data.client_secret;
      }

      function mountChatkit() {
        const mount = document.getElementById("mount");
        mount.innerHTML = "";

        const chatkit = document.createElement("openai-chatkit");
        chatkit.setOptions({
          api: {
            async getClientSecret(existing) {
              return existing || (await getClientSecret());
            },
          },
        });

        chatkit.style.height = "600px";
        chatkit.style.width = "360px";
        chatkit.style.maxWidth = "100%";
        chatkit.style.border = "1px solid #eee";
        chatkit.style.borderRadius = "16px";
        chatkit.style.overflow = "hidden";

        mount.appendChild(chatkit);
      }

      document.getElementById("start").addEventListener("click", async () => {
        await getClientSecret(); // sanity check
        mountChatkit();
      });
    </script>
  </body>
</html>
